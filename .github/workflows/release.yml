name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Release version (example 0.15.0)
        required: true
      build_real_run_id:
        description: GitHub Actions run ID of a successful build-real run
        required: true
      publish_live:
        description: Set true to allow live npm publish (still requires ALLOW_NPM_PUBLISH)
        required: true
        default: "false"

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      ALLOW_NPM_PUBLISH: ${{ vars.ALLOW_NPM_PUBLISH }}
      BUNDLE_DIR: bundle
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Download release bundle artifact from build-real
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.build_real_run_id }}
          github-token: ${{ github.token }}
          name: release-bundle-${{ inputs.version }}
          path: ${{ env.BUNDLE_DIR }}

      - name: Validate bundle structure
        run: |
          test -f "${BUNDLE_DIR}/manifests/${VERSION}.json"
          test -d "${BUNDLE_DIR}/packages"
          test -d "${BUNDLE_DIR}/dist"

      - name: Validate bundle publish (dry-run only)
        run: ./scripts/publish-from-bundle.sh "${BUNDLE_DIR}" --dry-run

      - name: Publish bundle packages (live)
        if: ${{ inputs.publish_live == 'true' }}
        run: ./scripts/publish-from-bundle.sh "${BUNDLE_DIR}"

      - name: Verify npm availability
        if: ${{ inputs.publish_live == 'true' }}
        run: npm run ci:check-npm
